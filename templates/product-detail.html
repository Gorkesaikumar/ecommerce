{% extends 'base.html' %}

{% block title %}{{ product.name }} | WoodCraft{% endblock %}

{% block skeleton_loader %}
<div id="initial-skeleton-overlay">
    <div class="sk-public-header">
         <div class="sk-logo sk-shimmer sk-rect"></div>
         <div class="sk-actions">
            <div class="sk-icon sk-shimmer sk-circle"></div>
        </div>
    </div>
    <div class="sk-container" style="display: flex; gap: 40px; margin-top: 40px; align-items: flex-start;">
        <!-- Left: Image -->
        <div class="sk-shimmer sk-rect" style="flex: 1; height: 500px; border-radius: 12px;"></div>
        
        <!-- Right: Info -->
        <div style="flex: 1; max-width: 500px;">
             <div class="sk-text-line sk-shimmer sk-rect" style="width: 30%; margin-bottom: 20px;"></div>
             <div class="sk-title-large sk-shimmer sk-rect" style="width: 80%; height: 50px; margin-bottom: 20px;"></div>
             <div class="sk-title-large sk-shimmer sk-rect" style="width: 40%; height: 40px; margin-bottom: 40px;"></div>
             
             <div class="sk-text-line sk-shimmer sk-rect" style="margin-bottom: 12px;"></div>
             <div class="sk-text-line sk-shimmer sk-rect" style="margin-bottom: 12px;"></div>
             <div class="sk-text-line sk-shimmer sk-rect" style="width: 80%; margin-bottom: 40px;"></div>
             
             <div class="sk-btn sk-shimmer sk-rect" style="height: 56px;"></div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    /* Container Layout */
    .product-detail-container {
        display: flex;
        gap: 40px;
        padding: 60px 0;
        align-items: flex-start;
        max-width: 1400px; /* Wider container for premium feel */
        margin: 0 auto;
    }
    
    /* Left Column: Gallery (60%) */
    .product-gallery {
        flex: 1.4; /* Takes up ~58% of space */
        min-width: 0; /* Prevents flex overflow */
    }
    
    .gallery-container {
        display: flex;
        flex-direction: row; /* Main Image | Thumbnails */
        gap: 20px;
        align-items: flex-start;
    }
    
    .main-image-wrapper {
        flex: 1;
        width: 100%;
        background: #fff; /* Clean white */
        border-radius: 4px;
        position: relative;
        cursor: crosshair;
        /* Remove fixed height constraint to allow natural scaling */
        aspect-ratio: 4/5; 
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .main-image-wrapper img {
        width: 100%;
        height: 100%;
        object-fit: contain; /* Ensure full product visibility */
        transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
        transform-origin: center center;
    }
    
    /* Thumbnails - Vertical Strip (Right of Main Image) */
    .thumbnails-strip {
        display: flex;
        flex-direction: column;
        gap: 12px;
        width: 100px; /* Slightly wider */
        flex-shrink: 0;
        /* NO SCROLLBARS - Allow natural height */
    }
    
    .thumb {
        width: 100%;
        aspect-ratio: 1;
        border-radius: 4px;
        border: 1px solid #eee; /* Subtle border */
        object-fit: contain;
        background: #fff;
        cursor: pointer;
        opacity: 0.6;
        transition: all 0.2s ease;
    }
    
    .thumb:hover, .thumb.active {
        border-color: #000;
        opacity: 1;
        box-shadow: 0 4px 12px rgba(0,0,0,0.08); /* Premium hover lift */
    }

    /* Right Column: Info (40%) */
    .product-info {
        flex: 1;
        padding-top: 10px; /* Optical alignment with image top */
    }

    /* Typography Improvements */
    .product-title {
        font-family: 'Playfair Display', serif;
        font-size: 48px; /* Larger, more dominant */
        font-weight: 400;
        color: #111;
        margin: 0 0 16px 0;
        line-height: 1.1;
        letter-spacing: -0.5px;
    }
    
    .product-price-lg {
        font-size: 26px;
        color: #333;
        font-weight: 500;
        margin-bottom: 32px;
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .product-description {
        font-size: 16px;
        color: #555;
        line-height: 1.7;
        margin-bottom: 40px;
        border-top: 1px solid #f0f0f0; /* Separator */
        padding-top: 24px;
    }

    /* Responsive */
    @media (max-width: 1024px) {
        .product-detail-container {
            flex-direction: column;
            padding: 40px 20px;
        }
        
        .gallery-container {
            justify-content: center;
        }

        .main-image-wrapper {
             max-height: 600px;
        }
    }
    
    @media (max-width: 768px) {
        .gallery-container {
            flex-direction: column-reverse; /* Thumbnails below on mobile */
            gap: 16px;
        }
        
        .thumbnails-strip {
            flex-direction: row;
            width: 100%;
            height: auto;
            overflow-x: auto;
            justify-content: flex-start;
        }
        
        .thumb {
            width: 70px;
            height: 70px;
        }
    }

    /* Related Products */
    .related-products-section {
        margin-top: 80px;
        border-top: 1px solid #eee;
        padding-top: 40px;
    }
    .related-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 24px;
        margin-top: 24px;
    }
    @media(max-width: 1024px) {
        .related-grid { grid-template-columns: repeat(2, 1fr); }
    }
    @media(max-width: 480px) {
        .related-grid { grid-template-columns: repeat(1, 1fr); }
    }

    
    /* Interactive Styles for Related Products */
    .product-card:hover .product-image img { transform: scale(1.05); } 
</style>
{% endblock %}

{% block content %}
<div class="product-detail-container">
    <!-- Left: Gallery -->
    <!-- Left: Gallery -->
    <div class="product-gallery">
        <div class="gallery-container">
            <!-- Main Image Frame -->
            <div class="main-image-wrapper" id="zoomContainer" onmousemove="zoomImage(event)" onmouseleave="resetZoom()">
                {% if product.image_urls %}
                <img src="{{ product.image_urls.0 }}" id="mainImage" alt="{{ product.name }}">
                {% else %}
                <img src="/static/img/product1.jpg" id="mainImage" alt="{{ product.name }}">
                {% endif %}
            </div>
            
            <!-- Thumbnails -->
            {% if product.image_urls|length > 1 %}
            <div class="thumbnails-strip">
                {% for img_url in product.image_urls %}
                <img src="{{ img_url }}" 
                     class="thumb {% if forloop.first %}active{% endif %}" 
                     onclick="switchImage(this)"
                     alt="Thumbnail {{ forloop.counter }}">
                {% endfor %}
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Right: Info -->
    <div class="product-info">
        <nav class="breadcrumb">
            <a href="/">Home</a> / 
            <a href="{% url 'product-list-frontend' %}">Shop</a> / 
            <span>{{ product.name }}</span>
        </nav>

        <h1 class="product-title">{{ product.name }}</h1>
        <div class="product-price-lg" id="productPrice">₹{{ product.base_price }}</div>

        <div class="product-description">
            {% if product.description %}
            {{ product.description|linebreaks }}
            {% else %}
            <p>Experience the perfect blend of form and function. This piece is crafted with meticulous attention to detail, designed to elevate your living space.</p>
            {% endif %}
        </div>

        <!-- Dimensions Selection -->
        <div class="dimension-box" style="margin-top: 24px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                <h4 style="margin: 0; font-family: 'Playfair Display', serif;">Dimensions</h4>
                <button onclick="openCustomModal()" style="background: none; border: none; color: #C5A065; font-size: 13px; font-weight: 500; cursor: pointer; text-decoration: underline;">
                     Own Customize?
                </button>
            </div>
            
            <div class="dimension-options" style="display: flex; flex-wrap: wrap; gap: 10px;">
                <!-- Exact Dimensions -->
                {% for dim in product.dimensions.all %}
                <label class="dim-radio-label">
                    <input type="radio" name="dimension" value="exact_{{ dim.id }}" data-price="{{ dim.price }}" {% if dim.is_default %}checked{% endif %} onchange="updatePrice(this)">
                    <span class="dim-badge">
                        {{ dim.length }}x{{ dim.breadth }}x{{ dim.height }} cm
                    </span>
                </label>
                {% endfor %}

                <!-- Range Dimensions (Fallback display) -->
                {% for config in product.dimension_configs.all %}
                    <div style="width: 100%; font-size: 12px; color: #888; margin-top: 4px;">
                        * Custom sizes available: {{ config.min_length }}-{{ config.max_length }}cm (L)
                    </div>
                {% endfor %}
            </div>
        </div>

        <div class="actions">
            {% if product.stock_quantity > 0 %}
                <button class="btn btn-add-large" data-product-id="{{ product.id }}">Add to Cart</button>
                
                {% if product.stock_quantity <= 100 %}
                <div style="margin-top: 12px; color: #ef6c00; font-weight: 500; font-size: 14px; display: flex; align-items: center; gap: 6px;">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg>
                    Hurry! Only {{ product.stock_quantity }} units left.
                </div>
                {% endif %}
                
                <div style="margin-top: 16px; font-size: 13px; color: var(--text-secondary); text-align: center;">
                    Processing: 2-3 Business Days
                </div>
            {% else %}
                <button class="btn btn-add-large" disabled style="background: #e0e0e0; color: #999; cursor: not-allowed; border: none;">Out of Stock</button>
                <div style="margin-top: 12px; color: #d32f2f; font-weight: 500; text-align: center;">
                    This item is currently unavailable.
                </div>
            {% endif %}
        </div>
    </div>
        </div>
    </div>
    
    <!-- Related Products -->
    {% if related_products %}
    <div class="related-products-section">
        <h3 style="font-family: 'Playfair Display', serif; font-size: 28px; color: #1a1a1a; text-align: center; margin-bottom: 8px;">You May Also Like</h3>
        <p style="text-align: center; color: var(--text-secondary); margin-bottom: 32px;">Curated selections from the same collection</p>
        
        <div class="related-grid" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 24px;">
            {% for rel_product in related_products %}
            <a href="{% url 'product-detail-slug-frontend' rel_product.slug|default:rel_product.id %}" class="product-card" style="display: block; text-decoration: none; color: inherit;">
                 <div class="product-image" style="width: 100%; aspect-ratio: 4/5; background: #fcfcfc; border-radius: 8px; overflow: hidden; margin-bottom: 12px; display: flex; align-items: center; justify-content: center;">
                    {% if rel_product.image_urls %}
                    <img src="{{ rel_product.image_urls.0 }}" alt="{{ rel_product.name }}" style="width: 100%; height: 100%; object-fit: contain; padding: 8px; transition: transform 0.3s;">
                    {% else %}
                    <img src="/static/img/product1.jpg" alt="" style="width: 100%; height: 100%; object-fit: contain;">
                    {% endif %}
                 </div>
                 <h4 style="font-size: 16px; font-weight: 500; margin-bottom: 4px;">{{ rel_product.name }}</h4>
                 <div style="font-size: 15px; color: var(--text-secondary);">₹{{ rel_product.base_price }}</div>
            </a>
            {% endfor %}
        </div>
    </div>
    {% endif %}
</div>

<!-- Customization Request Modal -->
<div id="customizeModal" class="modal-overlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; align-items: center; justify-content: center;">
    <div style="background: white; padding: 32px; border-radius: 12px; width: 90%; max-width: 450px; box-shadow: 0 20px 50px rgba(0,0,0,0.2);">
        <h3 style="font-family: 'Playfair Display', serif; font-size: 24px; color: #2C2420; margin-bottom: 8px;">Request Customization</h3>
        <p style="color: #666; font-size: 14px; margin-bottom: 24px;">Enter your desired dimensions. Our team will review and get back to you with a quote.</p>
        
        <form onsubmit="handleCustomizeSubmit(event)">
            <input type="hidden" id="custProductId" value="{{ product.id }}">
            
            <div class="form-grid-3" style="margin-bottom: 16px;">
                <div>
                    <label class="form-label">Length (cm) <span style="color: red">*</span></label>
                    <input type="number" id="reqL" class="form-input" required min="1" step="0.1">
                </div>
                <div>
                    <label class="form-label">Breadth (cm) <span style="color: red">*</span></label>
                    <input type="number" id="reqB" class="form-input" required min="1" step="0.1">
                </div>
                <div>
                    <label class="form-label">Height (cm) <span style="color: red">*</span></label>
                    <input type="number" id="reqH" class="form-input" required min="1" step="0.1">
                </div>
            </div>

            <div style="margin-bottom: 16px;">
                <label class="form-label">Your Name <span style="color: red">*</span></label>
                <input type="text" id="reqName" class="form-input" required value="{{ request.user.first_name }} {{ request.user.last_name }}">
            </div>

            <div class="form-grid-2" style="margin-bottom: 16px;">
                 <div>
                    <label class="form-label">Email <span style="color: red">*</span></label>
                    <input type="email" id="reqEmail" class="form-input" required value="{{ request.user.email }}">
                </div>
                <div>
                    <label class="form-label">Phone <span style="color: red">*</span></label>
                    <input type="tel" id="reqPhone" class="form-input" required value="{{ request.user.mobile_number }}">
                </div>
            </div>

            <div style="margin-bottom: 24px;">
                <label class="form-label">Additional Requirements</label>
                <textarea id="reqMsg" class="form-input" rows="2" placeholder="Tell us more about your needs..."></textarea>
            </div>

            <div style="display: flex; gap: 12px;">
                <button type="button" onclick="closeCustomModal()" class="btn btn-secondary" style="flex: 1;">Cancel</button>
                <button type="submit" class="btn btn-primary" style="flex: 1;">Send Request</button>
            </div>
        </form>
    </div>
</div>

<style>
    .dim-radio-label { cursor: pointer; }
    .dim-radio-label input { display: none; }
    .dim-badge { 
        display: inline-block; padding: 8px 16px; border: 1px solid #ddd; border-radius: 6px; 
        font-size: 14px; color: #555; transition: all 0.2s; 
    }
    .dim-radio-label input:checked + .dim-badge {
        background: #2C2420; color: white; border-color: #2C2420;
    }
    .form-input { 
        width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; margin-top: 4px; 
    }
    .form-input:focus { outline: none; border-color: #C5A065; }
    .form-label { font-size: 12px; font-weight: 600; color: #555; text-transform: uppercase; letter-spacing: 0.5px; }
</style>

<script>
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // --- Price Update Logic ---
    function updatePrice(radio) {
        const price = radio.dataset.price;
        if(price) {
            document.getElementById('productPrice').innerText = '₹' + parseFloat(price).toFixed(2);
        }
    }

    // --- Modal Logic ---
    function openCustomModal() {
        document.getElementById('customizeModal').style.display = 'flex';
    }

    function closeCustomModal() {
        document.getElementById('customizeModal').style.display = 'none';
    }

    window.onclick = function(e) {
        if (e.target.classList.contains('modal-overlay')) {
            closeCustomModal();
        }
    }

    async function handleCustomizeSubmit(e) {
        e.preventDefault();
        const btn = e.target.querySelector('button[type="submit"]');
        const originalText = btn.innerHTML;
        btn.innerHTML = 'Sending...';
        btn.disabled = true;

        const data = {
            product: document.getElementById('custProductId').value,
            length: parseFloat(document.getElementById('reqL').value),
            breadth: parseFloat(document.getElementById('reqB').value),
            height: parseFloat(document.getElementById('reqH').value),
            name: document.getElementById('reqName').value,
            email: document.getElementById('reqEmail').value,
            phone: document.getElementById('reqPhone').value,
            message: document.getElementById('reqMsg').value
        };

        try {
            const response = await fetch('/api/v1/products/customize-request', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify(data)
            });

            if (response.ok) {
                closeCustomModal();
                e.target.reset();
                showSuccessModal();
            } else {
                const err = await response.json();
                console.error(err);
                alert('Failed to send request. Please check inputs.');
            }
        } catch (error) {
            console.error(error);
            alert('Network error. Please try again.');
        } finally {
            btn.innerHTML = originalText;
            btn.disabled = false;
        }
    }
    
    function showSuccessModal() {
        document.getElementById('customSuccessModal').style.display = 'flex';
    }
    
    function closeSuccessModal() {
        document.getElementById('customSuccessModal').style.display = 'none';
    }

    // --- Gallery Logic ---
    function switchImage(thumb) {
        const mainImg = document.getElementById('mainImage');
        // Update Src
        mainImg.src = thumb.src;
        
        // Update Active Class
        document.querySelectorAll('.thumb').forEach(t => t.classList.remove('active'));
        thumb.classList.add('active');
        
        // Reset Zoom
        resetZoom();
    }

    // --- Zoom Logic ---
    function zoomImage(e) {
        const container = document.getElementById('zoomContainer');
        const img = document.getElementById('mainImage');
        
        const rect = container.getBoundingClientRect();
        
        // Calculate mouse position relative to container
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;
        
        // Calculate percentage (0-100)
        const xPercent = (x / rect.width) * 100;
        const yPercent = (y / rect.height) * 100;
        
        // Apply transform
        img.style.transformOrigin = `${xPercent}% ${yPercent}%`;
        img.style.transform = 'scale(2)'; // 2x Zoom level
    }

    function resetZoom() {
        const img = document.getElementById('mainImage');
        img.style.transform = 'scale(1)';
        img.style.transformOrigin = 'center center';
    }
</script>

<!-- Success Modal -->
<div id="customSuccessModal" class="modal-overlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2001; align-items: center; justify-content: center;">
    <div style="background: white; padding: 32px; border-radius: 12px; width: 90%; max-width: 420px; text-align: center; box-shadow: 0 20px 50px rgba(0,0,0,0.2);">
        <div style="width: 60px; height: 60px; background: #e8f5e9; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 20px;">
            <i class="fa-solid fa-check" style="font-size: 30px; color: #388e3c;"></i>
        </div>
        <h3 style="font-family: 'Playfair Display', serif; font-size: 24px; color: #2C2420; margin-bottom: 12px;">Request Submitted</h3>
        <p style="color: #555; font-size: 15px; line-height: 1.5; margin-bottom: 24px;">
            Your customization request has been received.
            <br><br>
            <strong>What's Next?</strong><br>
            • Please wait up to <strong>24 hours</strong> for admin approval.<br>
            • If approved, we will deliver within <strong>7 days</strong>.<br>
            • Admin will reach out if any clarification is needed.
        </p>
        <button onclick="closeSuccessModal()" class="btn btn-primary" style="width: 100%;">Okay, Got it</button>
    </div>
</div>
{% endblock %}
