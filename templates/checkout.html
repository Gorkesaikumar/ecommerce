{% extends 'base.html' %}

{% block title %}Checkout | WoodCraft{% endblock %}

{% block extra_css %}
<style>
    .checkout-grid {
        display: flex;
        gap: 32px;
        align-items: flex-start;
    }
    .checkout-form { flex: 2; }
    .order-summary { flex: 1; min-width: 320px; position: sticky; top: 100px; }

    @media (max-width: 1024px) {
        .order-summary {
            min-width: 0;
            width: 100%;
            position: static; /* Unstick on mobile to prevent layout issues */
        }
    }

    /* Responsive */
    @media (max-width: 1024px) {
        .checkout-grid {
            flex-direction: column-reverse; /* Summary on top for mobile? Or bottom? Usually bottom or collapsible. Let's keep standard flush. */
            flex-direction: column;
        }
        .order-summary {
            width: 100%;
            position: static;
            order: -1; /* Show summary first on mobile so they see what they buy? Or last? 
                          Standard is often summary collapsed at top. Let's keep it simply stacked at top (order -1) or bottom. 
                          Let's default to Natural flow (Form first) but many users prefer seeing price. 
                          Let's keep Form First (default order) for now to minimize friction. */
            order: 0; /* Reset */
            margin-bottom: 32px;
        }
    }

    @media (max-width: 768px) {
        .form-row-responsive {
            grid-template-columns: 1fr !important; /* Stack City/Zip */
        }
        .section {
            padding: 24px 16px;
        }
    }
</style>
{% endblock %}

{% block content %}
<section class="section">
    <div class="section-header">
        <h2>Checkout</h2>
    </div>

    <div class="checkout-grid responsive-split">
        <!-- Checkout Form -->
        <div class="checkout-form">
            <h3 style="margin-bottom: 16px;">Shipping Details</h3>
            <style>
                #checkoutForm .form-group {
                    margin-bottom: 12px;
                }
                .address-card {
                    border: 1px solid #ddd;
                    padding: 16px;
                    border-radius: 4px;
                    margin-bottom: 12px;
                    cursor: pointer;
                    display: block;
                }
                .address-card:has(input:checked) {
                    border-color: var(--primary-color);
                    background-color: #f9f9f9;
                }
            </style>
            <form id="checkoutForm" class="form-grid" style="gap: 12px;">
                
                {% if saved_addresses %}
                <div style="margin-bottom: 24px;">
                    <div style="font-weight: 600; margin-bottom: 12px;">Select Address</div>
                    
                    {% for addr in saved_addresses %}
                    <label class="address-card">
                        <div style="display: flex; gap: 12px; align-items: flex-start;">
                            <input type="radio" name="address_selection" value="{{ addr.id }}" {% if addr.is_default %}checked{% endif %} style="margin-top: 4px;">
                            <div>
                                <div style="font-weight: 500;">{{ addr.city }}</div>
                                <div style="font-size: 14px; color: #666;">{{ addr.line1 }}</div>
                                <div style="font-size: 13px; color: #666;">{{ addr.state }} - {{ addr.zip_code }}</div>
                            </div>
                        </div>
                    </label>
                    {% endfor %}

                    <label class="address-card">
                        <div style="display: flex; gap: 12px; align-items: center;">
                            <input type="radio" name="address_selection" value="new" {% if not saved_addresses %}checked{% endif %}>
                            <span style="font-weight: 500;">Add New Address</span>
                        </div>
                    </label>
                </div>
                {% endif %}

                <div id="newAddressForm" style="{% if saved_addresses %}display: none;{% endif %}">
                    <!-- New Address Fields Wrapper -->
                
                <div class="form-group">
                    <label class="form-label">Email Address</label>
                    <input type="email" name="email" required placeholder="For order confirmation" class="form-input">
                </div>

                <div class="form-group">
                    <label class="form-label">Phone Number</label>
                    <input type="tel" name="phone" required placeholder="+91" class="form-input">
                </div>

                <div class="form-group">
                    <label class="form-label">Street Address</label>
                    <input type="text" name="address" required placeholder="Flat, Building, Street" class="form-input">
                </div>

                <style>
                    .form-row-responsive {
                        display: grid; 
                        grid-template-columns: 1fr 1fr; 
                        gap: 20px;
                    }
                    @media (max-width: 768px) {
                        .form-row-responsive {
                            grid-template-columns: 1fr;
                            gap: 12px;
                        }
                    }
                </style>

                <div class="form-row-responsive">
                    <div>
                        <label class="form-label">City</label>
                        <input type="text" name="city" required placeholder="Hyderabad" class="form-input">
                    </div>

                    <div>
                         <label class="form-label">Zip Code</label>
                         <input type="text" name="zip" required placeholder="500001" class="form-input">
                    </div>
                </div>
                
                <div class="form-group">
                     <label class="form-label">State</label>
                     <input type="text" value="Telangana" disabled class="form-input">
                </div>
                </div> <!-- End newAddressForm -->

                <div style="margin-top: 24px;">
                    <h4 style="margin-bottom: 12px; font-size: 16px;">Payment Method</h4>
                    <div style="display: flex; gap: 16px;">
                        <label style="border: 1px solid #ddd; padding: 12px; border-radius: 4px; flex: 1; display: flex; align-items: center; cursor: pointer;">
                            <input type="radio" name="payment_method" value="ONLINE" checked style="margin-right: 8px;">
                            <span style="font-weight: 500;">Pay Online</span>
                        </label>
                        <label style="border: 1px solid #ddd; padding: 12px; border-radius: 4px; flex: 1; display: flex; align-items: center; cursor: pointer;">
                            <input type="radio" name="payment_method" value="COD" style="margin-right: 8px;">
                            <span style="font-weight: 500;">Cash on Delivery</span>
                        </label>
                    </div>
                </div>

                <div style="margin-top: 32px;">
                    <button type="submit" class="btn btn-primary" style="width: 100%; padding: 16px;">Place Order</button>
                    <div id="checkoutError" style="color: red; margin-top: 16px; text-align: center; display: none;"></div>
                </div>
            </form>
        </div>

        <!-- Order Summary -->
        <div class="order-summary" style="background: #F9F9F9; padding: 32px; border-radius: 4px; height: fit-content;">
            <h3 style="margin-bottom: 24px;">Your Order</h3>
            
            <div style="margin-bottom: 24px; max-height: 300px; overflow-y: auto;">
                {% for item in cart.items %}
                <div style="display: flex; gap: 16px; margin-bottom: 16px; align-items: center;">
                    <div style="width: 48px; height: 48px; background: #fff; border-radius: 4px; flex-shrink: 0; overflow: hidden;">
                        {% if item.product_details.image_urls %}
                        <img src="{{ item.product_details.image_urls.0 }}" style="width: 100%; height: 100%; object-fit: contain;">
                        {% endif %}
                    </div>
                    <div style="flex-grow: 1;">
                        <div style="font-size: 14px; font-weight: 500;">{{ item.product_details.name }}</div>
                        <div style="font-size: 13px; color: var(--text-secondary);">Qty: {{ item.quantity }}</div>
                    </div>
                    <div style="font-weight: 500;">₹{% widthratio item.price_details.final_price 1 item.quantity %}</div>
                </div>
                {% endfor %}
            </div>

            <div style="border-top: 1px solid #ddd; padding-top: 16px; display: flex; justify-content: space-between; font-weight: 600; font-size: 18px;">
                <span>Total</span>
                <span>₹{{ cart.total_price }}</span>
            </div>
        </div>
    </div>
</section>

<script>
    // Address Toggle Logic
    const addressRadios = document.querySelectorAll('input[name="address_selection"]');
    const newAddressForm = document.getElementById('newAddressForm');
    
    if(addressRadios.length > 0) {
        addressRadios.forEach(radio => {
            radio.addEventListener('change', (e) => {
                const inputs = newAddressForm.querySelectorAll('input');
                if(e.target.value === 'new') {
                    newAddressForm.style.display = 'block';
                    inputs.forEach(i => i.required = true);
                } else {
                    newAddressForm.style.display = 'none';
                    inputs.forEach(i => i.required = false);
                }
            });
        });
        
        // Init state
        const checked = document.querySelector('input[name="address_selection"]:checked');
        if(checked && checked.value !== 'new') {
            const inputs = newAddressForm.querySelectorAll('input');
             inputs.forEach(i => i.required = false);
        }
    }

    document.getElementById('checkoutForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const btn = this.querySelector('button[type="submit"]');
        const errorDiv = document.getElementById('checkoutError');
        const originalText = btn.innerText;
        
        btn.innerText = 'Processing...';
        btn.disabled = true;
        errorDiv.style.display = 'none';

        // Gather Data
        const formData = new FormData(this);
        const data = Object.fromEntries(formData.entries());
        
        const payload = {
            guest_email: data.email,
            guest_phone: data.phone,
            payment_method: data.payment_method
        };

        // Address Logic
        if (data.address_selection && data.address_selection !== 'new') {
             payload.address_id = data.address_selection;
        } else {
             payload.shipping_address = {
                street_address: data.address,
                city: data.city,
                postal_code: data.zip,
                state: 'Telangana',
                country: 'India',
                phone: data.phone
            };
        }

        try {
            const response = await fetch('/api/v1/orders/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken'),
                    'X-Session-Key': getCookie('session_key') || '' 
                },
                body: JSON.stringify(payload)
            });

            if (response.ok) {
                const order = await response.json();
                
                if (order.payment_method === 'COD') {
                    // Direct Success
                     window.location.href = `/api/v1/orders/${order.id}/invoice`; 
                } else {
                    // Redirect to Payment Page
                    window.location.href = `/api/v1/payments/checkout/${order.id}/payment/`; 
                }
            } else {
                const err = await response.json();
                let msg = 'Checkout failed';
                if(typeof err === 'object') {
                    // Try to extract first error
                    const keys = Object.keys(err);
                    if(keys.length > 0) {
                        const val = err[keys[0]];
                        msg = Array.isArray(val) ? val[0] : val;
                    }
                }
                errorDiv.innerText = msg;
                errorDiv.style.display = 'block';
            }
        } catch (e) {
            console.error(e);
            errorDiv.innerText = 'Network Error';
            errorDiv.style.display = 'block';
        } finally {
            btn.innerText = originalText;
            btn.disabled = false;
        }
    });

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
</script>
{% endblock %}
