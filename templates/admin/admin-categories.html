{% extends 'admin/base_admin.html' %}

{% block title %}Categories | Admin{% endblock %}

{% block admin_content %}
<div style="margin-bottom: 24px; display: flex; justify-content: space-between; align-items: end;">
    <div>
        <h2 style="font-family: 'Playfair Display', serif; font-size: 28px; color: #1a1a1a; margin-bottom: 8px;">Categories</h2>
        <p style="color: #666; font-size: 14px;">Manage product categories.</p>
    </div>
    <button onclick="openAddModal()" class="btn btn-primary">
        <i class="fa-solid fa-plus" style="margin-right: 8px;"></i> Add Category
    </button>
</div>

<div style="background: white; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.04); border: 1px solid rgba(0,0,0,0.04); overflow: hidden;">
    <div style="overflow-x: auto;">
        <table class="premium-table" style="width: 100%; border-collapse: collapse;">
            <thead>
                <tr style="background: #fafafa; border-bottom: 1px solid #eee;">
                    <th style="padding: 16px 24px; text-align: left; font-size: 12px; text-transform: uppercase;">Name</th>
                    <th style="padding: 16px 24px; text-align: left; font-size: 12px; text-transform: uppercase;">Slug</th>
                    <th style="padding: 16px 24px; text-align: center; font-size: 12px; text-transform: uppercase;">Products</th>
                    <th style="padding: 16px 24px; text-align: right; font-size: 12px; text-transform: uppercase;">Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for cat in categories %}
                <tr style="border-bottom: 1px solid #f9f9f9;">
                    <td style="padding: 16px 24px; font-weight: 500;">{{ cat.name }}</td>
                    <td style="padding: 16px 24px; color: #666; font-family: monospace;">{{ cat.slug }}</td>
                    <td style="padding: 16px 24px; text-align: center;">
                        <span style="background: #f5f5f5; padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 600;">{{ cat.product_count }}</span>
                    </td>
                    <td style="padding: 16px 24px; text-align: right;">
                        <button onclick="openEditModal('{{ cat.id }}', '{{ cat.name }}', '{{ cat.slug }}')" style="background: none; border: none; cursor: pointer; color: #1976d2; margin-right: 8px;" title="Edit">
                            <i class="fa-solid fa-pen-to-square"></i>
                        </button>
                        {% if cat.product_count == 0 %}
                        <button onclick="openDeleteModal('{{ cat.id }}')" style="background: none; border: none; cursor: pointer; color: #d32f2f;" title="Delete">
                            <i class="fa-solid fa-trash-can"></i>
                        </button>
                        {% else %}
                        <button disabled style="background: none; border: none; cursor: not-allowed; color: #ccc;" title="Cannot delete: has products">
                            <i class="fa-solid fa-trash-can"></i>
                        </button>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Add Category Modal -->
<div id="addCategoryModal" class="modal-overlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
    <div style="background: white; width: 90%; max-width: 400px; padding: 32px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.15);">
        <h3 style="margin-bottom: 24px;">Add Category</h3>
        <form onsubmit="handleCreate(event)">
            <div style="margin-bottom: 16px;">
                <label class="form-label">Name <span style="color: red;">*</span></label>
                <input type="text" id="addName" class="form-input" required oninput="generateSlug(this.value, 'addSlug')">
            </div>
            <div style="margin-bottom: 24px;">
                <label class="form-label">Slug <span style="color: red;">*</span></label>
                <input type="text" id="addSlug" class="form-input" required>
            </div>
            <div style="display: flex; gap: 12px; justify-content: flex-end;">
                <button type="button" onclick="closeAddModal()" class="btn btn-secondary">Cancel</button>
                <button type="submit" class="btn btn-primary">Create</button>
            </div>
        </form>
    </div>
</div>

<!-- Edit Category Modal -->
<div id="editCategoryModal" class="modal-overlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
    <div style="background: white; width: 90%; max-width: 400px; padding: 32px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.15);">
        <h3 style="margin-bottom: 24px;">Edit Category</h3>
        <form onsubmit="handleUpdate(event)">
            <input type="hidden" id="editId">
            <div style="margin-bottom: 16px;">
                <label class="form-label">Name <span style="color: red;">*</span></label>
                <input type="text" id="editName" class="form-input" required>
            </div>
            <div style="margin-bottom: 24px;">
                <label class="form-label">Slug <span style="color: red;">*</span></label>
                <input type="text" id="editSlug" class="form-input" required>
            </div>
            <div style="display: flex; gap: 12px; justify-content: flex-end;">
                <button type="button" onclick="closeEditModal()" class="btn btn-secondary">Cancel</button>
                <button type="submit" class="btn btn-primary">Save Changes</button>
            </div>
        </form>
    </div>
</div>

    <!-- Delete Category Modal -->
<div id="deleteCategoryModal" class="modal-overlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
    <div style="background: white; width: 90%; max-width: 400px; padding: 24px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.15);">
        <div style="text-align: center; margin-bottom: 24px;">
            <div style="width: 48px; height: 48px; background: #ffebee; color: #d32f2f; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 16px;">
                <i class="fa-solid fa-triangle-exclamation" style="font-size: 24px;"></i>
            </div>
            <h3 style="margin-bottom: 8px; font-size: 20px;">Delete Category?</h3>
            <p style="color: #666; font-size: 14px;">This action cannot be undone. This may affect products linked to this category.</p>
        </div>
        
        <input type="hidden" id="deleteId">
        
        <div style="display: flex; gap: 12px; justify-content: center;">
            <button onclick="closeDeleteModal()" class="btn btn-secondary" style="flex: 1;">Cancel</button>
            <button onclick="confirmDelete()" class="btn" style="flex: 1; background: #d32f2f; color: white; border: none; padding: 12px; border-radius: 6px; cursor: pointer; font-weight: 500;">Delete</button>
        </div>
    </div>
</div>

<script>
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    function generateSlug(text, targetId) {
        const slug = text.toLowerCase()
            .replace(/[^\w ]+/g, '')
            .replace(/ +/g, '-');
        document.getElementById(targetId).value = slug;
    }

    // Modal Controls
    
    // Add
    function openAddModal() {
        document.getElementById('addCategoryModal').style.display = 'flex';
        document.getElementById('addName').focus();
    }

    function closeAddModal() {
        document.getElementById('addCategoryModal').style.display = 'none';
        document.getElementById('addName').value = '';
        document.getElementById('addSlug').value = '';
    }

    // Edit
    function openEditModal(id, name, slug) {
        document.getElementById('editId').value = id;
        document.getElementById('editName').value = name;
        document.getElementById('editSlug').value = slug;
        document.getElementById('editCategoryModal').style.display = 'flex';
    }

    function closeEditModal() {
        document.getElementById('editCategoryModal').style.display = 'none';
    }
    
    // Delete
    function openDeleteModal(id) {
        document.getElementById('deleteId').value = id;
        document.getElementById('deleteCategoryModal').style.display = 'flex';
    }
    
    function closeDeleteModal() {
        document.getElementById('deleteCategoryModal').style.display = 'none';
    }

    // Using global window.showAdminToast from base_admin.html

    async function handleCreate(e) {
        e.preventDefault();
        const btn = e.target.querySelector('button[type="submit"]');
        const originalText = btn.innerHTML;
        btn.innerHTML = 'Creating...';
        btn.disabled = true;

        const data = {
            name: document.getElementById('addName').value,
            slug: document.getElementById('addSlug').value
        };

        try {
            const response = await fetch('/api/v1/admin/categories/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify(data)
            });

            if (response.ok) {
                closeAddModal();
                window.showAdminToast('Category created successfully!', 'success');
                setTimeout(() => location.reload(), 1000);
            } else {
                const res = await response.json();
                window.showAdminToast(res.slug ? 'Slug already exists' : 'Failed to create', 'error');
            }
        } catch (err) {
            console.error(err);
            window.showAdminToast('Network error', 'error');
        } finally {
            btn.innerHTML = originalText;
            btn.disabled = false;
        }
    }

    async function handleUpdate(e) {
        e.preventDefault();
        const id = document.getElementById('editId').value;
        const btn = e.target.querySelector('button[type="submit"]');
        
        btn.innerHTML = 'Saving...';
        btn.disabled = true;

        const data = {
            name: document.getElementById('editName').value,
            slug: document.getElementById('editSlug').value
        };

        try {
            const response = await fetch(`/api/v1/admin/categories/${id}/`, {
                method: 'PATCH',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify(data)
            });

            if (response.ok) {
                closeEditModal();
                window.showAdminToast('Category updated successfully!', 'success');
                setTimeout(() => location.reload(), 1000);
            } else {
                window.showAdminToast('Failed to update category', 'error');
            }
        } catch (err) {
            console.error(err);
            window.showAdminToast('Network error', 'error');
        } finally {
            btn.innerHTML = 'Save Changes';
            btn.disabled = false;
        }
    }

    async function confirmDelete() {
        const id = document.getElementById('deleteId').value;
        if(!id) return;
        
        const btn = document.querySelector('#deleteCategoryModal button[onclick="confirmDelete()"]');
        const originalText = btn.innerHTML;
        btn.innerHTML = 'Deleting...';
        btn.disabled = true;

        try {
            console.log('Attempting to delete category ID:', id);
            const response = await fetch(`/api/v1/admin/categories/${id}/`, {
                method: 'DELETE',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken')
                }
            });

            console.log('Response status:', response.status);
            console.log('Response ok:', response.ok);

            if (response.ok || response.status === 204) {
                 closeDeleteModal();
                 window.showAdminToast('Category deleted successfully', 'delete');
                 setTimeout(() => location.reload(), 1000);
            } else {
                const responseText = await response.text();
                console.log('Error response text:', responseText);
                
                let errorMsg = 'Failed to delete category';
                try {
                    const res = JSON.parse(responseText);
                    console.log('Parsed error response:', res);
                    // Handle both array format (ValidationError) and object format
                    if (Array.isArray(res)) {
                        errorMsg = res[0] || errorMsg;
                    } else if (res.detail) {
                        errorMsg = res.detail;
                    } else if (res.error) {
                        errorMsg = res.error;
                    } else if (typeof res === 'string') {
                        errorMsg = res;
                    }
                } catch(e) {
                    console.error('Failed to parse error response:', e);
                    errorMsg = responseText || errorMsg;
                }
                
                console.log('Final error message:', errorMsg);
                window.showAdminToast(errorMsg, 'error');
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        } catch (err) {
            console.error('Network error:', err);
            window.showAdminToast('Network error', 'error');
            btn.innerHTML = originalText;
            btn.disabled = false;
        }
    }

    // Close Modals on outside click
    window.onclick = function(e) {
        if (e.target.classList.contains('modal-overlay')) {
            e.target.style.display = 'none';
        }
    }
</script>
{% endblock %}
