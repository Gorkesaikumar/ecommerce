{% extends 'admin/base_admin.html' %}

{% block title %}Coupons & Offers | Admin{% endblock %}

{% block admin_content %}
<div style="margin-bottom: 24px; display: flex; justify-content: space-between; align-items: end;">
    <div>
        <h2 style="font-family: 'Playfair Display', serif; font-size: 28px; color: #1a1a1a; margin-bottom: 8px;">Coupons & Offers</h2>
        <p style="color: #666; font-size: 14px;">Create and manage discount codes for customers.</p>
    </div>
    <button onclick="openPromoModal()" class="btn btn-primary" style="display: flex; align-items: center; gap: 8px; background: #2C2420; color: white; padding: 12px 24px; border-radius: 6px;">
        <i class="fa-solid fa-plus"></i> Create Coupon
    </button>
</div>

<div style="background: white; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.04); border: 1px solid rgba(0,0,0,0.04); overflow: hidden;">
    <div style="overflow-x: auto;">
        <table class="premium-table" style="width: 100%; border-collapse: collapse;">
            <thead>
                <tr style="background: #fafafa; border-bottom: 1px solid #eee;">
                    <th style="padding: 16px 24px; text-align: left;">Code</th>
                    <th style="padding: 16px 24px; text-align: left;">Discount</th>
                    <th style="padding: 16px 24px; text-align: left;">Valid Period</th>
                    <th style="padding: 16px 24px; text-align: left;">Usage</th>
                    <th style="padding: 16px 24px; text-align:  center;">Status</th>
                    <th style="padding: 16px 24px; text-align: right;">Action</th>
                </tr>
            </thead>
            <tbody>
                {% for promo in promocodes %}
                <tr style="border-bottom: 1px solid #f9f9f9;">
                    <td style="padding: 16px 24px;">
                        <div style="font-weight: 600; font-family: monospace; font-size: 15px; color: #2C2420; background: #eee; padding: 4px 8px; border-radius: 4px; display: inline-block;">{{ promo.code }}</div>
                        {% if promo.description %}
                        <div style="font-size: 12px; color: #888; margin-top: 4px;">{{ promo.description }}</div>
                        {% endif %}
                    </td>
                    <td style="padding: 16px 24px;">
                        {% if promo.discount_type == 'PERCENT' %}
                            <span style="color: #2e7d32; font-weight: 600;">{{ promo.discount_value }}% OFF</span>
                        {% else %}
                            <span style="color: #2e7d32; font-weight: 600;">₹{{ promo.discount_value }} FLAT</span>
                        {% endif %}
                        <div style="font-size: 11px; color: #999;">Min Order: ₹{{ promo.min_order_amount }}</div>
                    </td>
                    <td style="padding: 16px 24px; font-size: 13px; color: #555;">
                        {{ promo.valid_from|date:"M d" }} - {{ promo.valid_until|date:"M d, Y" }}
                    </td>
                    <td style="padding: 16px 24px; font-size: 13px;">
                        {{ promo.usage_count }} / 
                        {% if promo.usage_limit %}{{ promo.usage_limit }}{% else %}∞{% endif %}
                    </td>
                    <td style="padding: 16px 24px; text-align: center;">
                        {% if promo.is_active %}
                        <span class="badge badge-success">Active</span>
                        {% else %}
                        <span class="badge badge-neutral">Inactive</span>
                        {% endif %}
                    </td>
                    <td style="padding: 16px 24px; text-align: right; white-space: nowrap;">
                        <button onclick="editPromo(this)" 
                            data-id="{{ promo.id }}"
                            data-code="{{ promo.code }}"
                            data-description="{{ promo.description|default:'' }}"
                            data-type="{{ promo.discount_type }}"
                            data-value="{{ promo.discount_value }}"
                            data-min="{{ promo.min_order_amount }}"
                            data-limit="{{ promo.usage_limit|default:'' }}"
                            data-from="{{ promo.valid_from|date:'Y-m-d' }}"
                            data-until="{{ promo.valid_until|date:'Y-m-d' }}"
                            style="background: none; border: none; color: #666; cursor: pointer; margin-right: 8px;" title="Edit">
                            <i class="fa-solid fa-pen"></i>
                        </button>
                        <button onclick="deletePromo('{{ promo.id }}')" style="background: none; border: none; color: #d32f2f; cursor: pointer;" title="Delete">
                            <i class="fa-solid fa-trash"></i>
                        </button>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="6" style="padding: 48px; text-align: center; color: #888;">No coupons created yet.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Add/Edit Modal -->
<div id="promoModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
    <div style="background: white; padding: 32px; border-radius: 12px; width: 90%; max-width: 500px; box-shadow: 0 4px 20px rgba(0,0,0,0.15);">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
            <h3 id="modalTitle" style="font-family: var(--font-heading); margin: 0;">Create Coupon</h3>
            <button onclick="closePromoModal()" style="background: none; border: none; font-size: 24px; cursor: pointer;">&times;</button>
        </div>
        
        <form id="promoForm" onsubmit="handlePromoSubmit(event)">
            <input type="hidden" name="id" id="promoId">
            <div class="form-group">
                <label class="form-label">Coupon Code</label>
                <input type="text" name="code" class="form-input" placeholder="e.g. SUMMER50" required style="text-transform: uppercase;" oninput="this.value = this.value.toUpperCase()">
            </div>
            
            <div class="form-group">
                <label class="form-label">Description</label>
                <input type="text" name="description" class="form-input" placeholder="e.g. 50% Off Summer Sale">
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                <div class="form-group">
                    <label class="form-label">Discount Type</label>
                    <select name="discount_type" class="form-input">
                        <option value="PERCENT">Percentage (%)</option>
                        <option value="FIXED">Fixed Amount (₹)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Value</label>
                    <input type="number" name="discount_value" class="form-input" placeholder="0.00" step="0.01" required>
                </div>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                 <div class="form-group">
                    <label class="form-label">Min Order (₹)</label>
                    <input type="number" name="min_order_amount" class="form-input" value="0">
                </div>
                 <div class="form-group">
                    <label class="form-label">Usage Limit</label>
                    <input type="number" name="usage_limit" class="form-input" placeholder="Leave empty for unlimited">
                </div>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                <div class="form-group">
                    <label class="form-label">Start Date</label>
                    <input type="date" name="valid_from" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label">End Date</label>
                    <input type="date" name="valid_until" class="form-input" required>
                </div>
            </div>

            <div style="text-align: right; margin-top: 16px;">
                <button type="submit" id="submitBtn" class="btn btn-primary" style="width: 100%;">Create Coupon</button>
            </div>
        </form>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div id="deleteModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
    <div style="background: white; padding: 24px; border-radius: 12px; width: 90%; max-width: 400px; box-shadow: 0 4px 20px rgba(0,0,0,0.15); text-align: center;">
        <div style="width: 50px; height: 50px; background: #ffebee; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 16px;">
            <i class="fa-solid fa-trash" style="color: #d32f2f; font-size: 20px;"></i>
        </div>
        <h3 style="font-family: var(--font-heading); margin: 0 0 8px; color: #1a1a1a;">Delete Coupon?</h3>
        <p style="color: #666; font-size: 14px; margin: 0 0 24px;">Are you sure you want to delete this coupon? This action cannot be undone.</p>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
            <button onclick="closeDeleteModal()" style="padding: 10px; border: 1px solid #ddd; background: white; border-radius: 6px; cursor: pointer; color: #555; font-weight: 500;">Cancel</button>
            <button onclick="confirmDelete()" id="confirmDeleteBtn" style="padding: 10px; border: none; background: #d32f2f; border-radius: 6px; cursor: pointer; color: white; font-weight: 500;">Delete</button>
        </div>
    </div>
</div>

<script>
    let deleteTargetId = null;

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    function openPromoModal() {
        // Create Mode
        document.getElementById('promoForm').reset();
        document.getElementById('promoId').value = '';
        document.getElementById('modalTitle').innerText = 'Create Coupon';
        document.getElementById('submitBtn').innerText = 'Create Coupon';
        
        // Use Local Date for defaults
        const now = new Date();
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, '0');
        const day = String(now.getDate()).padStart(2, '0');
        const today = `${year}-${month}-${day}`;
        
        // Set default dates
        document.querySelector('input[name="valid_from"]').value = today;
        document.querySelector('input[name="valid_until"]').value = today;
        
        document.getElementById('promoModal').style.display = 'flex';
    }

    function editPromo(btn) {
        // Edit Mode
        const form = document.getElementById('promoForm');
        form.reset();
        
        document.getElementById('promoId').value = btn.dataset.id;
        document.getElementById('modalTitle').innerText = 'Edit Coupon';
        document.getElementById('submitBtn').innerText = 'Update Coupon';
        
        form.querySelector('[name="code"]').value = btn.dataset.code;
        form.querySelector('[name="description"]').value = btn.dataset.description;
        form.querySelector('[name="discount_type"]').value = btn.dataset.type;
        form.querySelector('[name="discount_value"]').value = btn.dataset.value;
        form.querySelector('[name="min_order_amount"]').value = btn.dataset.min;
        form.querySelector('[name="usage_limit"]').value = btn.dataset.limit;
        form.querySelector('[name="valid_from"]').value = btn.dataset.from;
        form.querySelector('[name="valid_until"]').value = btn.dataset.until;
        
        document.getElementById('promoModal').style.display = 'flex';
    }

    function closePromoModal() {
        document.getElementById('promoModal').style.display = 'none';
    }

    async function handlePromoSubmit(e) {
        e.preventDefault();
        const btn = document.getElementById('submitBtn');
        const originalText = btn.innerText;
        btn.innerHTML = 'Saving...';
        btn.disabled = true;

        const formData = new FormData(e.target);
        const data = Object.fromEntries(formData.entries());
        const id = data.id; // Get ID from hidden field
        
        // Force Uppercase Code
        if(data.code) data.code = data.code.toUpperCase();
        
        // Ensure values are correct types matches local day boundaries
        if(data.valid_from) data.valid_from = new Date(data.valid_from + 'T00:00:00').toISOString();
        if(data.valid_until) data.valid_until = new Date(data.valid_until + 'T23:59:59').toISOString();
        if(data.usage_limit === '') delete data.usage_limit;

        // Determine URL and Method
        let url = '/api/v1/promotions/admin/promocodes/';
        let method = 'POST';
        
        if (id) {
            url += `${id}/`;
            method = 'PATCH';
            delete data.id; // Remove ID from payload for update
        }

        try {
            const response = await fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify(data)
            });

            if (response.ok) {
                window.showAdminToast(id ? 'Coupon updated' : 'Coupon created', 'success');
                setTimeout(() => location.reload(), 1000);
            } else {
                let msg = 'Failed to save';
                try {
                    const err = await response.json();
                    if(err.code) msg = 'Code: ' + err.code[0];
                    else if(err.detail) msg = err.detail;
                    else if(typeof err === 'object') {
                         // Get first error message from object
                         const firstKey = Object.keys(err)[0];
                         msg = `${firstKey}: ${err[firstKey][0]}`;
                    }
                } catch(e) {
                    msg = `Server Error: ${response.status} ${response.statusText}`;
                    console.error('Non-JSON response:', await response.text());
                }
                window.showAdminToast(msg, 'error');
            }
        } catch (error) {
            console.error(error);
            window.showAdminToast('Network error or Server Crash', 'error');
        } finally {
            btn.innerHTML = originalText;
            btn.disabled = false;
        }
    }

    function deletePromo(id) {
        deleteTargetId = id;
        document.getElementById('deleteModal').style.display = 'flex';
    }

    function closeDeleteModal() {
        document.getElementById('deleteModal').style.display = 'none';
        deleteTargetId = null;
    }

    async function confirmDelete() {
        if (!deleteTargetId) return;

        const btn = document.getElementById('confirmDeleteBtn');
        const originalText = btn.innerText;
        btn.innerText = 'Deleting...';
        btn.disabled = true;

        try {
            const response = await fetch(`/api/v1/promotions/admin/promocodes/${deleteTargetId}/`, {
                method: 'DELETE',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken')
                }
            });
            if (response.ok || response.status === 204) {
                 window.showAdminToast('Coupon deleted', 'delete');
                 setTimeout(() => location.reload(), 1000);
            } else {
                 window.showAdminToast('Failed to delete', 'error');
                 closeDeleteModal();
            }
        } catch(e) {
            console.error(e);
            window.showAdminToast('Network error', 'error');
            closeDeleteModal();
        } finally {
            btn.innerText = originalText;
            btn.disabled = false;
        }
    }
    
    // Outside click
    window.onclick = function(e) {
        const promoModal = document.getElementById('promoModal');
        const deleteModal = document.getElementById('deleteModal');
        
        if (e.target === promoModal) {
            closePromoModal();
        }
        if (e.target === deleteModal) {
            closeDeleteModal();
        }
    }
</script>
{% endblock %}
