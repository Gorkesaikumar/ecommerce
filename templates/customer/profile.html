{% extends 'base.html' %}

{% block title %}Profile | WoodCraft{% endblock %}

{% block content %}
<section class="section">
    <div class="dashboard-layout">
        {% include 'customer/sidebar.html' %}

        <main>
            <div style="margin-bottom: 32px;">
                <h2 style="font-family: var(--font-heading);">Profile Details</h2>
            </div>

            <div class="card" style="padding: 32px; border: 1px solid #eee; border-radius: 8px;">
                <form id="profileForm" class="form-grid" style="max-width: 600px;">
                    <!-- Hidden field for ID if needed, but endpoint uses request.user -->
                    <div class="form-group">
                        <label class="form-label">Full Name</label>
                        <input type="text" id="name" value="{{ request.user.name|default:'' }}" class="form-input" placeholder="Your Name">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Email Address</label>
                        <input type="email" id="email" value="{{ request.user.email|default:'' }}" class="form-input" placeholder="email@example.com">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Mobile Number</label>
                        <input type="text" value="{{ request.user.mobile_number }}" disabled class="form-input" style="background-color: #f5f5f5; cursor: not-allowed;">
                        <div style="font-size: 12px; color: var(--text-secondary); margin-top: 8px;">Verified via OTP</div>
                    </div>
                    
                    <button type="submit" id="saveBtn" class="btn btn-primary">Update Profile</button>
                    <p id="msg" style="margin-top: 16px; font-size: 14px; display: none;"></p>
                </form>
            </div>
        </main>
    </div>
</section>

<script>
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    document.getElementById('profileForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const btn = document.getElementById('saveBtn');
        const msg = document.getElementById('msg');
        btn.disabled = true;
        btn.innerText = 'Updating...';
        msg.style.display = 'none';

        const data = {
            name: document.getElementById('name').value,
            email: document.getElementById('email').value
        };

        try {
            const res = await fetch('/api/v1/auth/profile', {
                method: 'PATCH',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify(data)
            });

            if (res.ok) {
                showToast('Profile updated successfully!');
            } else {
                const err = await res.json();
                showToast('Error: ' + JSON.stringify(err), true);
            }
        } catch (error) {
            console.error(error);
            msg.style.color = 'red';
            msg.innerText = 'Network error occurred.';
            msg.style.display = 'block';
        } finally {
            btn.disabled = false;
            btn.innerText = 'Update Profile';
        }
    });
</script>
{% endblock %}
